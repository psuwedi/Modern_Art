<!DOCTYPE html>
<html><head>
<title>Adding a Shopping Cart</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script type="text/javascript" src="Adding%20a%20Shopping%20Cart_files/48356a79ca"></script><script src="Adding%20a%20Shopping%20Cart_files/nr-1071.js"></script><script async="" src="Adding%20a%20Shopping%20Cart_files/analytics.js"></script><script src="Adding%20a%20Shopping%20Cart_files/Gy5a6AgvmvRZuSjIcKRIBTwX4nQ.js"></script><script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"bam.nr-data.net","errorBeacon":"bam.nr-data.net","licenseKey":"48356a79ca","applicationID":"1386295","transactionName":"IAwPEhQNWVxUFx5VUBAQDggVTUZYXhI=","queueTime":3,"applicationTime":60,"agent":""}</script>
<script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(e,t,n){function r(n){if(!t[n]){var o=t[n]={exports:{}};e[n][0].call(o.exports,function(t){var o=e[n][1][t];return r(o||t)},o,o.exports)}return t[n].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<n.length;o++)r(n[o]);return r}({1:[function(e,t,n){function r(){}function o(e,t,n){return function(){return i(e,[f.now()].concat(u(arguments)),t?null:this,n),t?void 0:this}}var i=e("handle"),a=e(2),u=e(3),c=e("ee").get("tracer"),f=e("loader"),s=NREUM;"undefined"==typeof window.newrelic&&(newrelic=s);var p=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],d="api-",l=d+"ixn-";a(p,function(e,t){s[t]=o(d+t,!0,"api")}),s.addPageAction=o(d+"addPageAction",!0),s.setCurrentRouteName=o(d+"routeName",!0),t.exports=newrelic,s.interaction=function(){return(new r).get()};var m=r.prototype={createTracer:function(e,t){var n={},r=this,o="function"==typeof t;return i(l+"tracer",[f.now(),e,n],r),function(){if(c.emit((o?"":"no-")+"fn-start",[f.now(),r,o],n),o)try{return t.apply(this,arguments)}catch(e){throw c.emit("fn-err",[arguments,this,e],n),e}finally{c.emit("fn-end",[f.now()],n)}}}};a("setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(e,t){m[t]=o(l+t)}),newrelic.noticeError=function(e){"string"==typeof e&&(e=new Error(e)),i("err",[e,f.now()])}},{}],2:[function(e,t,n){function r(e,t){var n=[],r="",i=0;for(r in e)o.call(e,r)&&(n[i]=t(r,e[r]),i+=1);return n}var o=Object.prototype.hasOwnProperty;t.exports=r},{}],3:[function(e,t,n){function r(e,t,n){t||(t=0),"undefined"==typeof n&&(n=e?e.length:0);for(var r=-1,o=n-t||0,i=Array(o<0?0:o);++r<o;)i[r]=e[t+r];return i}t.exports=r},{}],4:[function(e,t,n){t.exports={exists:"undefined"!=typeof window.performance&&window.performance.timing&&"undefined"!=typeof window.performance.timing.navigationStart}},{}],ee:[function(e,t,n){function r(){}function o(e){function t(e){return e&&e instanceof r?e:e?c(e,u,i):i()}function n(n,r,o,i){if(!d.aborted||i){e&&e(n,r,o);for(var a=t(o),u=m(n),c=u.length,f=0;f<c;f++)u[f].apply(a,r);var p=s[y[n]];return p&&p.push([b,n,r,a]),a}}function l(e,t){v[e]=m(e).concat(t)}function m(e){return v[e]||[]}function w(e){return p[e]=p[e]||o(n)}function g(e,t){f(e,function(e,n){t=t||"feature",y[n]=t,t in s||(s[t]=[])})}var v={},y={},b={on:l,emit:n,get:w,listeners:m,context:t,buffer:g,abort:a,aborted:!1};return b}function i(){return new r}function a(){(s.api||s.feature)&&(d.aborted=!0,s=d.backlog={})}var u="nr@context",c=e("gos"),f=e(2),s={},p={},d=t.exports=o();d.backlog=s},{}],gos:[function(e,t,n){function r(e,t,n){if(o.call(e,t))return e[t];var r=n();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(e,t,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return e[t]=r,r}var o=Object.prototype.hasOwnProperty;t.exports=r},{}],handle:[function(e,t,n){function r(e,t,n,r){o.buffer([e],r),o.emit(e,t,n)}var o=e("ee").get("handle");t.exports=r,r.ee=o},{}],id:[function(e,t,n){function r(e){var t=typeof e;return!e||"object"!==t&&"function"!==t?-1:e===window?0:a(e,i,function(){return o++})}var o=1,i="nr@id",a=e("gos");t.exports=r},{}],loader:[function(e,t,n){function r(){if(!x++){var e=h.info=NREUM.info,t=d.getElementsByTagName("script")[0];if(setTimeout(s.abort,3e4),!(e&&e.licenseKey&&e.applicationID&&t))return s.abort();f(y,function(t,n){e[t]||(e[t]=n)}),c("mark",["onload",a()+h.offset],null,"api");var n=d.createElement("script");n.src="https://"+e.agent,t.parentNode.insertBefore(n,t)}}function o(){"complete"===d.readyState&&i()}function i(){c("mark",["domContent",a()+h.offset],null,"api")}function a(){return E.exists&&performance.now?Math.round(performance.now()):(u=Math.max((new Date).getTime(),u))-h.offset}var u=(new Date).getTime(),c=e("handle"),f=e(2),s=e("ee"),p=window,d=p.document,l="addEventListener",m="attachEvent",w=p.XMLHttpRequest,g=w&&w.prototype;NREUM.o={ST:setTimeout,SI:p.setImmediate,CT:clearTimeout,XHR:w,REQ:p.Request,EV:p.Event,PR:p.Promise,MO:p.MutationObserver};var v=""+location,y={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-1071.min.js"},b=w&&g&&g[l]&&!/CriOS/.test(navigator.userAgent),h=t.exports={offset:u,now:a,origin:v,features:{},xhrWrappable:b};e(1),d[l]?(d[l]("DOMContentLoaded",i,!1),p[l]("load",r,!1)):(d[m]("onreadystatechange",o),p[m]("onload",r)),c("mark",["firstbyte",u],null,"api");var x=0,E=e(4)},{}]},{},["loader"]);</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="utf-8">
<!--[if lt IE 9]>
    <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
<meta name="csrf-param" content="authenticity_token">
<meta name="csrf-token" content="l38gL+2RAPdf0BpDOLaEXXYU96AqfVX4JhUA32UxW36O/B24pSzzoIjQDyBUTqCF1VZXOLtGytJQ2YO5WX2f9Q==">
<link rel="stylesheet" media="all" href="Adding%20a%20Shopping%20Cart_files/application-3ef6cb77227173b65eee1a35be8f4651bfcf3c1598d323d2.css">
<link rel="shortcut icon" type="image/x-icon" href="https://www.learnhowtoprogram.com/assets/favicon-d0e8ff63da72a0c5ea15ebc045a7f9d2979d211a12e596a5ed5f5b1534e78919.png">
<link href="Adding%20a%20Shopping%20Cart_files/css.css" rel="stylesheet" type="text/css">
<script src="Adding%20a%20Shopping%20Cart_files/application-0b1fe5213457eca6944576110bff4cad83a370d0669ce729f.js"></script>
<style id="fit-vids-style">.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}</style><style type="text/css" media="print">.usabilla_live_button_container { display: none; }</style></head>
<body><div style="display: none;" id="lightningjs-usabilla_live"><div><iframe id="lightningjs-frame-usabilla_live" frameborder="0"></iframe></div></div>
<div class="container">
<div class="row">
<div class="col-xs-12">
<span class="label label-info">Lesson</span>
<span class="label label-primary">Weekend</span>
<ul class="breadcrumb">
<li><a href="https://www.learnhowtoprogram.com/rails">Rails</a></li>
<li><a href="https://www.learnhowtoprogram.com/rails/building-an-e-commerce-site-with-ajax-and-apis">Building an E-Commerce Site with AJAX and APIs</a></li>
<li class="active">Adding a Shopping Cart</li>
</ul>
<ul class="nav nav-tabs">
<li class="active"><a href="#text" data-toggle="tab">Text</a></li>
</ul>
<div class="tab-content">
<div class="tab-pane active in" id="text">
<p>Let's add a shopping cart to a Rails application. Users will be able 
to add and remove items from their shopping carts. They’ll also be able 
to view their shopping carts and see an updated total price for their 
orders. We'll use highly abstracted class names such as <code class="prettyprint prettyprinted" style=""><span class="typ">Product</span></code>, <code class="prettyprint prettyprinted" style=""><span class="typ">Order</span></code> and <code class="prettyprint prettyprinted" style=""><span class="typ">Order_Item</span></code> so our shopping cart code is reusable for other applications we make in the future.</p>
<h2>Setting Up Our Schema</h2>
<p>First, we'll build our schema. For now, our schema will be very basic.</p>
<p><img src="Adding%20a%20Shopping%20Cart_files/Shopping-Cart-Schema.png" alt="alt-image-tag"></p>
<p>Let’s briefly go over these tables.</p>
<p><strong>Accounts:</strong> We’ll start with the <code class="prettyprint prettyprinted" style=""><span class="pln">accounts</span></code> table. Why have <code class="prettyprint prettyprinted" style=""><span class="pln">accounts</span></code> instead of <code class="prettyprint prettyprinted" style=""><span class="pln">users</span></code>?
 If your application includes Devise for authentication, the Devise User
 model should be kept separate from your application logic. In this 
example, a <code class="prettyprint prettyprinted" style=""><span class="typ">User</span></code> would have a one-to-one relationship with an <code class="prettyprint prettyprinted" style=""><span class="typ">Account</span></code>.
 Even if you use bcrypt or other authentication, any table that stores 
passwords should be kept separate from other tables in the database for 
security purposes. We'll leave it to you to set up authentication on 
your own. Note that it's a bit more challenging to set up the one-to-one
 relationship between <code class="prettyprint prettyprinted" style=""><span class="typ">Account</span></code> and <code class="prettyprint prettyprinted" style=""><span class="typ">User</span></code>
 and get it all working with authentication. So while it's a best 
practice to separate out tables in this way, it's by no means required. 
If you choose not to do the one-to-one relationship, then there'd be no <code class="prettyprint prettyprinted" style=""><span class="typ">Account</span></code> model, just a <code class="prettyprint prettyprinted" style=""><span class="typ">User</span></code> model (which would take the place of the accounts table in the illustration above).</p>
<p><strong>Products:</strong> This is fairly self-explanatory. Our products will have a name and price. Each <code class="prettyprint prettyprinted" style=""><span class="pln">product</span></code> will have many <code class="prettyprint prettyprinted" style=""><span class="pln">order_items</span></code>. You may want to add Paperclip for images and other fields such as description. Note that price should be a <code class="prettyprint prettyprinted" style=""><span class="typ">BigDecimal</span></code> field. We'll use <code class="prettyprint prettyprinted" style=""><span class="typ">BigDecimal</span></code> because it has more precision than <code class="prettyprint prettyprinted" style=""><span class="typ">Float</span></code>, which can have rounding errors due to the way binary numbers are stored in memory. Floats are computed more quickly but <code class="prettyprint prettyprinted" style=""><span class="typ">BigDecimal</span></code> should be used when working with currency.</p>
<p><strong>Orders:</strong> Our orders need to have a <code class="prettyprint prettyprinted" style=""><span class="pln">status</span></code>. For instance, are they <code class="prettyprint prettyprinted" style=""><span class="pln">pending</span></code> or <code class="prettyprint prettyprinted" style=""><span class="pln">shipped</span></code>? An <code class="prettyprint prettyprinted" style=""><span class="pln">order</span></code> belongs to a <code class="prettyprint prettyprinted" style=""><span class="pln">user</span></code> and a <code class="prettyprint prettyprinted" style=""><span class="pln">user</span></code> can have many <code class="prettyprint prettyprinted" style=""><span class="pln">orders</span></code>.</p>
<p>Our orders also need to have a <code class="prettyprint prettyprinted" style=""><span class="pln">total_price</span></code>
 which will be updated each time an item is added or subtracted from a 
customer's shopping cart. Once again, this is very basic. You may also 
want to consider fields for <code class="prettyprint prettyprinted" style=""><span class="pln">tax</span></code>, <code class="prettyprint prettyprinted" style=""><span class="pln">shipping</span></code>, and <code class="prettyprint prettyprinted" style=""><span class="pln">subtotal</span></code> as well as for the total price. Most real world orders also include an order number so they can be tracked. </p>
<p><strong>Order_items:</strong> Our <code class="prettyprint prettyprinted" style=""><span class="pln">order_items</span></code> belong to both <code class="prettyprint prettyprinted" style=""><span class="pln">products</span></code> and <code class="prettyprint prettyprinted" style=""><span class="pln">orders</span></code>. An <code class="prettyprint prettyprinted" style=""><span class="pln">order</span></code> can have many <code class="prettyprint prettyprinted" style=""><span class="pln">order_items</span></code>. This way, a customer can put many products into a shopping cart. A <code class="prettyprint prettyprinted" style=""><span class="pln">product</span></code> can have many <code class="prettyprint prettyprinted" style=""><span class="pln">order_items</span></code> as well, since many customers could order the same product.</p>
<p>Alternatively, we could create a <code class="prettyprint prettyprinted" style=""><span class="pln">has_many </span><span class="pun">:</span><span class="pln">through</span></code> relationship between <code class="prettyprint prettyprinted" style=""><span class="pln">products</span></code> and <code class="prettyprint prettyprinted" style=""><span class="pln">orders</span></code>. If we did that, the <code class="prettyprint prettyprinted" style=""><span class="pln">quantity</span></code> field would be on the join table instead. For simplicity's sake, we are using one-to-many relationships instead (where <code class="prettyprint prettyprinted" style=""><span class="pln">product_items</span></code> belongs to both <code class="prettyprint prettyprinted" style=""><span class="pln">products</span></code> and <code class="prettyprint prettyprinted" style=""><span class="pln">orders</span></code>).</p>
<p>Go ahead and set up your database. You can start with this barebones schema or customize your schema further.</p>
<h2>Getting Started</h2>
<p>Our application will need the following:</p>
<ul>
<li><strong>Models:</strong> Add models for <em>product.rb</em>, <em>order.rb</em>, and <em>order_item.rb</em> and then set up your model relationships. Here are the relationships we're using: OTM between <code class="prettyprint prettyprinted" style=""><span class="pln">product</span></code> and <code class="prettyprint prettyprinted" style=""><span class="pln">order_item</span></code>, OTM between <code class="prettyprint prettyprinted" style=""><span class="pln">order</span></code>and <code class="prettyprint prettyprinted" style=""><span class="pln">order_item</span></code>. We won't cover setting up a OTM relationship between an <code class="prettyprint prettyprinted" style=""><span class="pln">account</span></code> and <code class="prettyprint prettyprinted" style=""><span class="pln">orders</span></code> here, but you can add that later if you choose to include authentication in your application.</li>
<li><strong>Routes:</strong> Add routes in <code class="prettyprint prettyprinted" style=""><span class="pln">config</span><span class="pun">/</span><span class="pln">routes</span><span class="pun">.</span><span class="pln">rb</span></code> for <code class="prettyprint prettyprinted" style=""><span class="pln">products</span></code> and <code class="prettyprint prettyprinted" style=""><span class="pln">order_items</span></code>. Don't worry about the cart just yet.</li>
<li><strong>Seeding the Database:</strong> Create a seed file for products and run <code class="prettyprint prettyprinted" style=""><span class="pln">$ rake db</span><span class="pun">:</span><span class="pln">seed</span></code>.</li>
</ul>
<p>Now we're ready to build our shopping cart!</p>
<h2>Building a current_order helper method</h2>
<p>We'll start by adding a <code class="prettyprint prettyprinted" style=""><span class="pln">current_order</span></code>
 helper method to our Application Controller so it's available to all 
controllers and views. This will provide similar functionality as 
Devise's <code class="prettyprint prettyprinted" style=""><span class="pln">current_user</span></code> helper method. Instead of determining the current user, though, we'll have access to the current order.</p>
<div class="filename">controllers/application_controller.rb</div>
<pre><code class="prettyprint lang-ruby prettyprinted" style=""><span class="kwd">class</span><span class="pln"> </span><span class="typ">ApplicationController</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="typ">ActionController</span><span class="pun">::</span><span class="typ">Base</span><span class="pln">
  protect_from_forgery </span><span class="kwd">with</span><span class="pun">:</span><span class="pln"> </span><span class="pun">:</span><span class="pln">exception
  helper_method </span><span class="pun">:</span><span class="pln">current_order

  </span><span class="kwd">def</span><span class="pln"> current_order
    </span><span class="kwd">if</span><span class="pln"> session</span><span class="pun">[:</span><span class="pln">order_id</span><span class="pun">]</span><span class="pln">
      </span><span class="typ">Order</span><span class="pun">.</span><span class="pln">find</span><span class="pun">(</span><span class="pln">session</span><span class="pun">[:</span><span class="pln">order_id</span><span class="pun">])</span><span class="pln">
    </span><span class="kwd">else</span><span class="pln">
      </span><span class="typ">Order</span><span class="pun">.</span><span class="kwd">new</span><span class="pln">
    </span><span class="kwd">end</span><span class="pln">
  </span><span class="kwd">end</span><span class="pln">
</span><span class="kwd">end</span></code></pre>
<p>Let's quickly summarize what this method does. When <code class="prettyprint prettyprinted" style=""><span class="pln">current_order</span></code> is called, we'll check if there's an <code class="prettyprint prettyprinted" style=""><span class="pln">order_id</span></code> associated with the session and then find that order. If there isn't, we'll create a new order.</p>
<p>We've also added <code class="prettyprint prettyprinted" style=""><span class="pln">helper_method </span><span class="pun">:</span><span class="pln">current_order</span></code>, making this method available to our controllers and views.</p>
<p>We haven't created a <code class="prettyprint prettyprinted" style=""><span class="pln">session</span><span class="pun">[:</span><span class="pln">order_id</span><span class="pun">]</span></code> yet, but we'll get to that soon.</p>
<h2>Adding an Item to the Cart</h2>
<p>Our <em>index.html.erb</em> should have an "Add to Cart" button for each product, so our <em>index.html.erb</em> should include code like this:</p>
<div class="filename">views/products/index.html.erb</div>
<pre><code class="prettyprint lang-ruby prettyprinted" style=""><span class="pln"> </span><span class="pun">&lt;%</span><span class="pln"> </span><span class="lit">@products</span><span class="pun">.</span><span class="pln">each </span><span class="kwd">do</span><span class="pln"> </span><span class="pun">|</span><span class="pln">product</span><span class="pun">|</span><span class="pln"> %&gt;
  </span><span class="tag">&lt;p&gt;</span><span class="pun">&lt;%=</span><span class="pln"> product</span><span class="pun">.</span><span class="pln">name %&gt; | </span><span class="pun">&lt;%=</span><span class="pln"> number_to_currency product</span><span class="pun">.</span><span class="pln">price %&gt;
  </span><span class="pun">&lt;%=</span><span class="pln"> form_for </span><span class="lit">@order_item</span><span class="pln"> </span><span class="kwd">do</span><span class="pln"> </span><span class="pun">|</span><span class="pln">f</span><span class="pun">|</span><span class="pln"> %&gt;
    </span><span class="pun">&lt;%=</span><span class="pln"> f</span><span class="pun">.</span><span class="pln">hidden_field </span><span class="pun">:</span><span class="pln">product_id</span><span class="pun">,</span><span class="pln"> value</span><span class="pun">:</span><span class="pln"> product</span><span class="pun">.</span><span class="pln">id %&gt;
    </span><span class="pun">&lt;%=</span><span class="pln"> f</span><span class="pun">.</span><span class="pln">number_field </span><span class="pun">:</span><span class="pln">quantity %&gt;
    </span><span class="pun">&lt;%=</span><span class="pln"> f</span><span class="pun">.</span><span class="pln">submit </span><span class="str">"Add to cart"</span><span class="pln"> %&gt;
  </span><span class="pun">&lt;%</span><span class="pln"> </span><span class="kwd">end</span><span class="pln"> %&gt;</span><span class="tag">&lt;/p&gt;</span><span class="pln">
</span><span class="pun">&lt;%</span><span class="pln"> </span><span class="kwd">end</span><span class="pln"> %&gt;</span></code></pre>
<p>Let's go over a few things here. First, we have the <code class="prettyprint prettyprinted" style=""><span class="pln">number_to_currency</span></code> helper method. This built-in Rails helper method automatically converts the price to a currency format. Check out the <a href="http://api.rubyonrails.org/classes/ActionView/Helpers/NumberHelper.html#method-i-number_to_currency">documentation</a> on Rails number helpers for more information.</p>
<p>Next, we specify that our form is for <code class="prettyprint prettyprinted" style=""><span class="lit">@order_item</span></code>, <strong>not</strong> product. Remember, we don't want to save products to the shopping cart. We want to save <code class="prettyprint prettyprinted" style=""><span class="pln">order_item</span></code>s to each order instead. Passing in a hidden field for the <code class="prettyprint prettyprinted" style=""><span class="pln">product_id</span></code> will allow us to associate an <code class="prettyprint prettyprinted" style=""><span class="pln">order_item</span></code> with the correct product.</p>
<p>Once we add this form, our <em>index.html.erb</em> page doesn't work anymore. That's because we need to define our <code class="prettyprint prettyprinted" style=""><span class="lit">@order_item</span></code> instance variable in <em>products_controller.rb</em>. We'll modify the index route to look like this:</p>
<div class="filename">controllers/products_controller.rb</div>
<pre><code class="prettyprint lang-ruby prettyprinted" style=""><span class="kwd">def</span><span class="pln"> index
  </span><span class="lit">@products</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Product</span><span class="pun">.</span><span class="pln">all
  </span><span class="lit">@order_item</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> current_order</span><span class="pun">.</span><span class="pln">order_items</span><span class="pun">.</span><span class="kwd">new</span><span class="pln">
</span><span class="kwd">end</span></code></pre>
<p>When a user submits the form, a new <code class="prettyprint prettyprinted" style=""><span class="pln">order_item</span></code> will be instantiated inside of <code class="prettyprint prettyprinted" style=""><span class="pln">current_order</span></code>, so it will be available to the create route in <em>order_Items_controller.rb</em>.</p>
<p>If we load the products index page and click the "Add to Cart" button, we get an error: <code class="prettyprint prettyprinted" style=""><span class="typ">Unable</span><span class="pln"> to autoload constant </span><span class="typ">OrderItemsController</span></code>.</p>
<p>Of course. We haven't made the corresponding controller action yet. 
Note that the form is automatically looking for a create action in <em>order_items_controller.rb</em>, not <em>products_controller.rb</em>. Remember, we specified form_for @order_item, not @product.</p>
<p>Let's add <em>order_Items_controller.rb</em> along with the code to add an item to the shopping cart.</p>
<div class="filename">controllers/order_items_controller.rb</div>
<pre><code class="prettyprint lang-ruby prettyprinted" style=""><span class="kwd">class</span><span class="pln"> </span><span class="typ">OrderItemsController</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="typ">ApplicationController</span><span class="pln">

  </span><span class="kwd">def</span><span class="pln"> create
    </span><span class="lit">@order</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> current_order
    </span><span class="lit">@item</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">@order</span><span class="pun">.</span><span class="pln">order_items</span><span class="pun">.</span><span class="kwd">new</span><span class="pun">(</span><span class="pln">item_params</span><span class="pun">)</span><span class="pln">
    </span><span class="lit">@order</span><span class="pun">.</span><span class="pln">save
    session</span><span class="pun">[:</span><span class="pln">order_id</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">@order</span><span class="pun">.</span><span class="pln">id
    redirect_to products_path
  </span><span class="kwd">end</span><span class="pln">

  </span><span class="kwd">private</span><span class="pln">

  </span><span class="kwd">def</span><span class="pln"> item_params
    </span><span class="kwd">params</span><span class="pun">.</span><span class="kwd">require</span><span class="pun">(:</span><span class="pln">order_item</span><span class="pun">).</span><span class="pln">permit</span><span class="pun">(:</span><span class="pln">quantity</span><span class="pun">,</span><span class="pln"> </span><span class="pun">:</span><span class="pln">product_id</span><span class="pun">)</span><span class="pln">
  </span><span class="kwd">end</span><span class="pln">
</span><span class="kwd">end</span></code></pre>
<p>We start by calling <code class="prettyprint prettyprinted" style=""><span class="pln">current_order</span></code>. Because we haven't set <code class="prettyprint prettyprinted" style=""><span class="pln">session</span><span class="pun">[:</span><span class="pln">order_id</span><span class="pun">]</span></code> yet, our <code class="prettyprint prettyprinted" style=""><span class="pln">current_order</span></code> method in <em>application_controller.rb</em> will set <code class="prettyprint prettyprinted" style=""><span class="lit">@order</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Order</span><span class="pun">.</span><span class="kwd">new</span></code>. We add the <code class="prettyprint prettyprinted" style=""><span class="pln">order_item</span></code> to the order and then save the order. Finally, we set the value of <code class="prettyprint prettyprinted" style=""><span class="pln">session</span><span class="pun">[:</span><span class="pln">order_id</span><span class="pun">]</span></code> to our newly instantiated <code class="prettyprint prettyprinted" style=""><span class="lit">@order</span><span class="pun">.</span><span class="pln">id</span></code>. The next time <code class="prettyprint prettyprinted" style=""><span class="pln">current_order</span></code> is called, it will automatically find the correct order for <code class="prettyprint prettyprinted" style=""><span class="lit">@order</span></code>. No messy global variable necessary! Our Rails session will keep track of <code class="prettyprint prettyprinted" style=""><span class="pun">[:</span><span class="pln">order_id</span><span class="pun">]</span></code> for us. The <code class="prettyprint prettyprinted" style=""><span class="pun">[:</span><span class="pln">order_id</span><span class="pun">]</span></code> value will remain until the browser's cache is cleared (removing the cookie that holds the <code class="prettyprint prettyprinted" style=""><span class="pun">[:</span><span class="pln">order_id</span><span class="pun">]</span></code>) or we execute code that clears its value.</p>
<p>We can use the Rails console to confirm that order_items are properly
 being saved to our order. Try adding a product to the shopping cart. In
 the Rails console, put <code class="prettyprint prettyprinted" style=""><span class="typ">Order</span><span class="pun">.</span><span class="pln">first</span><span class="pun">.</span><span class="pln">order_items</span></code>.</p>
<h2>Viewing and Updating the Shopping Cart</h2>
<p>Now it's time to add a shopping cart so our customers can see the items they’ve added. Let's add <em>carts_controller.rb</em>:</p>
<div class="filename">controllers/carts_controller.rb</div>
<pre><code class="prettyprint lang-ruby prettyprinted" style=""><span class="kwd">class</span><span class="pln"> </span><span class="typ">CartsController</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="typ">ApplicationController</span><span class="pln">

  </span><span class="kwd">def</span><span class="pln"> show
    </span><span class="lit">@order_items</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> current_order</span><span class="pun">.</span><span class="pln">order_items
  </span><span class="kwd">end</span><span class="pln">
</span><span class="kwd">end</span></code></pre>
<p>Once again we access the <code class="prettyprint prettyprinted" style=""><span class="pln">current_order</span></code> to determine the<code class="prettyprint prettyprinted" style=""><span class="pln">order_item</span></code>s for the customer's order. We can now use the instance variable <code class="prettyprint prettyprinted" style=""><span class="lit">@order_item</span></code>s to access all the <code class="prettyprint prettyprinted" style=""><span class="pln">order_item</span></code>s in <em>views/carts/show.html.erb</em>. We only need a show route for our cart so our routes should reflect that:</p>
<div class="filename">config/routes.rb</div>
<pre><code class="prettyprint lang-ruby prettyprinted" style=""><span class="pln">resource </span><span class="pun">:</span><span class="pln">cart</span><span class="pun">,</span><span class="pln"> only</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[:</span><span class="pln">show</span><span class="pun">]</span></code></pre>
<p>Note that we're using <code class="prettyprint prettyprinted" style=""><span class="pln">resource</span></code> instead of <code class="prettyprint prettyprinted" style=""><span class="pln">resources</span></code>. You can run <code class="prettyprint prettyprinted" style=""><span class="pln">$ rake routes</span></code>
 to see the difference between the two. The key difference is that the 
routes are changed from plural to singular because a customer will have 
only one shopping cart. Now we have <em>/cart/:id</em> instead of <em>/carts/:id</em>. By default, <code class="prettyprint prettyprinted" style=""><span class="pln">resource</span></code> doesn't create an <code class="prettyprint prettyprinted" style=""><span class="pln">index</span></code>
 route (since there's no need to show all carts when we only have one). 
That's not a factor here since we only want the show route, but you 
should be aware of this difference.</p>
<p>Here's the view for our shopping cart:</p>
<div class="filename">views/carts/show.html.erb</div>
<pre><code class="prettyprint lang-ruby prettyprinted" style=""><span class="pun">&lt;%</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="lit">@order_items</span><span class="pun">.</span><span class="pln">any</span><span class="pun">?</span><span class="pln"> %&gt;
  </span><span class="pun">&lt;%</span><span class="pln"> </span><span class="lit">@order_items</span><span class="pun">.</span><span class="pln">each </span><span class="kwd">do</span><span class="pln"> </span><span class="pun">|</span><span class="pln">item</span><span class="pun">|</span><span class="pln"> %&gt;
    </span><span class="tag">&lt;p&gt;</span><span class="pun">&lt;%=</span><span class="pln"> item</span><span class="pun">.</span><span class="pln">product</span><span class="pun">.</span><span class="pln">name %&gt; | </span><span class="pun">&lt;%=</span><span class="pln"> link_to </span><span class="str">"Delete"</span><span class="pun">,</span><span class="pln"> order_item_path</span><span class="pun">(</span><span class="pln">item</span><span class="pun">),</span><span class="pln"> </span><span class="pun">:</span><span class="pln">data </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{:</span><span class="pln">confirm </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">"You sure?"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">:</span><span class="pln">method </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="str">"delete"</span><span class="pun">}</span><span class="pln"> %&gt;</span><span class="tag">&lt;/p&gt;</span><span class="pln">
    </span><span class="tag">&lt;p&gt;</span><span class="pln"> Unit Price: </span><span class="pun">&lt;%=</span><span class="pln"> number_to_currency item</span><span class="pun">.</span><span class="pln">product</span><span class="pun">.</span><span class="pln">price %&gt; | Quantity: </span><span class="pun">&lt;%=</span><span class="pln"> item</span><span class="pun">.</span><span class="pln">quantity %&gt; | Total Price: </span><span class="pun">&lt;%=</span><span class="pln"> number_to_currency </span><span class="pun">(</span><span class="pln">item</span><span class="pun">.</span><span class="pln">product</span><span class="pun">.</span><span class="pln">price </span><span class="pun">*</span><span class="pln"> item</span><span class="pun">.</span><span class="pln">quantity</span><span class="pun">)</span><span class="pln"> %&gt;</span><span class="tag">&lt;/p&gt;</span><span class="pln">
  </span><span class="pun">&lt;%</span><span class="pln"> </span><span class="kwd">end</span><span class="pln"> %&gt;
  </span><span class="tag">&lt;p&gt;</span><span class="pln">Your Total: </span><span class="pun">&lt;%=</span><span class="pln"> number_to_currency current_order</span><span class="pun">.</span><span class="pln">total_price %&gt;</span><span class="tag">&lt;/p&gt;</span><span class="pln">
</span><span class="pun">&lt;%</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> %&gt;
  </span><span class="tag">&lt;p&gt;</span><span class="pln">Your shopping cart is empty.</span><span class="tag">&lt;/p&gt;</span><span class="pln">
</span><span class="pun">&lt;%</span><span class="pln"> </span><span class="kwd">end</span><span class="pln"> %&gt;</span></code></pre>
<p>This is very basic. Our shopping cart shows each <code class="prettyprint prettyprinted" style=""><span class="pln">order_item</span></code>,
 including the quantity and price of that item. We've also added an 
option to remove an item from the shopping cart with a delete path. 
Let's add the code for the destroy path in the <em>order_items.rb</em> controller:</p>
<div class="filename">order_items_controller.rb</div>
<pre><code class="prettyprint lang-ruby prettyprinted" style=""><span class="pln">  </span><span class="kwd">def</span><span class="pln"> destroy
    </span><span class="lit">@order</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> current_order
    </span><span class="lit">@item</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">@order</span><span class="pun">.</span><span class="pln">order_items</span><span class="pun">.</span><span class="pln">find</span><span class="pun">(</span><span class="kwd">params</span><span class="pun">[:</span><span class="pln">id</span><span class="pun">])</span><span class="pln">
    </span><span class="lit">@item</span><span class="pun">.</span><span class="pln">destroy
    </span><span class="lit">@order</span><span class="pun">.</span><span class="pln">save
    redirect_to cart_path
  </span><span class="kwd">end</span></code></pre>
<p>The code here is straightforward. However, why should we save <code class="prettyprint prettyprinted" style=""><span class="lit">@order</span></code>? When <code class="prettyprint prettyprinted" style=""><span class="lit">@item</span></code> is destroyed, the order's <code class="prettyprint prettyprinted" style=""><span class="pln">order_item</span></code>s are properly updated.</p>
<p>Let's answer that question by addressing an issue with our shopping cart view. The current order's <code class="prettyprint prettyprinted" style=""><span class="pln">total_price</span></code> is <code class="prettyprint prettyprinted" style=""><span class="lit">0</span></code> even if we add items to the shopping cart. Remember, our orders also have <code class="prettyprint prettyprinted" style=""><span class="pln">status</span></code> and <code class="prettyprint prettyprinted" style=""><span class="pln">total_price</span></code>
 fields. The total price of the order should be updated whenever changes
 are made and the order status should be updated to "In progress" when 
it's created.</p>
<p>We can quickly add this functionality with a few callbacks. Here we go:</p>
<div class="filename">models/order.rb</div>
<pre><code class="prettyprint lang-ruby prettyprinted" style=""><span class="kwd">class</span><span class="pln"> </span><span class="typ">Order</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> </span><span class="typ">ApplicationRecord</span><span class="pln">
  has_many </span><span class="pun">:</span><span class="pln">order_items
  before_save </span><span class="pun">:</span><span class="pln">update_total
  before_create </span><span class="pun">:</span><span class="pln">update_status

  </span><span class="kwd">def</span><span class="pln"> calculate_total
    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">order_items</span><span class="pun">.</span><span class="pln">collect </span><span class="pun">{</span><span class="pln"> </span><span class="pun">|</span><span class="pln">item</span><span class="pun">|</span><span class="pln"> item</span><span class="pun">.</span><span class="pln">product</span><span class="pun">.</span><span class="pln">price </span><span class="pun">*</span><span class="pln"> item</span><span class="pun">.</span><span class="pln">quantity </span><span class="pun">}.</span><span class="pln">sum
  </span><span class="kwd">end</span><span class="pln">

  </span><span class="kwd">private</span><span class="pln">

  </span><span class="kwd">def</span><span class="pln"> update_status
    </span><span class="kwd">if</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">status </span><span class="pun">==</span><span class="pln"> </span><span class="kwd">nil</span><span class="pun">?</span><span class="pln">
      </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">status </span><span class="pun">=</span><span class="pln"> </span><span class="str">"In progress"</span><span class="pln">
    </span><span class="kwd">end</span><span class="pln">
  </span><span class="kwd">end</span><span class="pln">

  </span><span class="kwd">def</span><span class="pln"> update_total
    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">total_price </span><span class="pun">=</span><span class="pln"> calculate_total
  </span><span class="kwd">end</span><span class="pln">
</span><span class="kwd">end</span></code></pre>
<p>We have two callbacks here: <code class="prettyprint prettyprinted" style=""><span class="pln">before_save </span><span class="pun">:</span><span class="pln">update_total</span></code> and <code class="prettyprint prettyprinted" style=""><span class="pln">before_create </span><span class="pun">:</span><span class="pln">update_status</span></code>.</p>
<p><code class="prettyprint prettyprinted" style=""><span class="pln">update_total</span></code> is a <code class="prettyprint prettyprinted" style=""><span class="kwd">private</span></code> method that will call the <code class="prettyprint prettyprinted" style=""><span class="pln">calculate_total</span></code> method and then update the <code class="prettyprint prettyprinted" style=""><span class="pln">total_price</span></code> of the order.</p>
<p><code class="prettyprint prettyprinted" style=""><span class="pln">update_status</span></code> is a <code class="prettyprint prettyprinted" style=""><span class="kwd">private</span></code> method that will change the status of the order to <code class="prettyprint prettyprinted" style=""><span class="str">"In progress"</span></code> as long as order's status is nil. An order should only have a <code class="prettyprint prettyprinted" style=""><span class="kwd">nil</span></code> status when it's first created, which is when we'll want to change its status to <code class="prettyprint prettyprinted" style=""><span class="str">"In progress"</span></code>.</p>
<p>We also have a <code class="prettyprint prettyprinted" style=""><span class="kwd">public</span></code> method: <code class="prettyprint prettyprinted" style=""><span class="pln">calculate_total</span></code>. This method is <code class="prettyprint prettyprinted" style=""><span class="kwd">public</span></code> so it can be used in our views if we need it. Remember that methods should be <code class="prettyprint prettyprinted" style=""><span class="kwd">private</span></code>
 if they'll only be called in the model. If you'll need them in other 
parts of the code such as the controller, they'll usually be <code class="prettyprint prettyprinted" style=""><span class="kwd">public</span></code>. (Methods can also be <code class="prettyprint prettyprinted" style=""><span class="kwd">protected</span></code> as well, but that's beyond the scope of this lesson.)</p>
<p>If there are any <code class="prettyprint prettyprinted" style=""><span class="pln">order_item</span></code>s,
 then we'll take the price of each item, multiply the price by its 
quantity, and put the value in an array. We'll then sum the array to get
 the total price of the order.</p>
<p>Now it should be clear why we're saving the order in the <code class="prettyprint prettyprinted" style=""><span class="pln">order_item</span></code> destroy path. This ensures that the <code class="prettyprint prettyprinted" style=""><span class="pln">update_total</span></code> callback is triggered, which will update the <code class="prettyprint prettyprinted" style=""><span class="pln">total_price</span></code> each time we delete an <code class="prettyprint prettyprinted" style=""><span class="pln">order_item</span></code>.</p>
<p>Our shopping cart is still very basic. Customers can add and remove 
products from their shopping carts and also see the total price of their
 orders. This week you'll get the chance to build your own e-commerce 
sites and customize this shopping cart further.</p>
</div>
</div>
</div>
</div>
</div>
<nav class="navbar navbar-default navbar-fixed-top">
<div class="container">
<div class="navbar-header">
<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="https://www.learnhowtoprogram.com/courses">Courses</a>
</div>
<div id="navbar" class="collapse navbar-collapse">
<ul class="nav navbar-nav">
<li> </li><li><a href="https://www.learnhowtoprogram.com/rails/building-an-e-commerce-site-with-ajax-and-apis/building-an-e-commerce-site-with-ajax-and-apis-objectives">Previous</a></li>
<li><a href="https://www.learnhowtoprogram.com/rails/building-an-e-commerce-site-with-ajax-and-apis/making-api-calls-in-rails">Next</a></li>

</ul>
<ul class="nav navbar-nav pull-right">
<li id="navbar-search">
<form class="navbar-form navbar-left" action="/lessons" accept-charset="UTF-8" method="get"><input name="utf8" value="✓" type="hidden">
<div class="input-group">
<input name="search" id="search" placeholder="Search lessons" class="form-control" type="text">
<div class="input-group-btn">
<button name="button" type="submit" class="btn btn-info" id="lesson-search">
<span class="glyphicon glyphicon-search"></span>
</button> </div>
</div>
</form> </li>
</ul>
</div>
</div>
</nav>
<footer class="footer">
<div class="container">
<p>© 2018 <a href="http://www.epicodus.com/">Epicodus</a>, Inc.</p>
</div>
</footer>

<script type="text/javascript">/*{literal}<![CDATA[*/window.lightningjs||function(c){function g(b,d){d&&(d+=(/\?/.test(d)?"&":"?")+"lv=1");c[b]||function(){var i=window,h=document,j=b,g=h.location.protocol,l="load",k=0;(function(){function b(){a.P(l);a.w=1;c[j]("_load")}c[j]=function(){function m(){m.id=e;return c[j].apply(m,arguments)}var b,e=++k;b=this&&this!=i?this.id||0:0;(a.s=a.s||[]).push([e,b,arguments]);m.then=function(b,c,h){var d=a.fh[e]=a.fh[e]||[],j=a.eh[e]=a.eh[e]||[],f=a.ph[e]=a.ph[e]||[];b&&d.push(b);c&&j.push(c);h&&f.push(h);return m};return m};var a=c[j]._={};a.fh={};a.eh={};a.ph={};a.l=d?d.replace(/^\/\//,(g=="https:"?g:"http:")+"//"):d;a.p={0:+new Date};a.P=function(b){a.p[b]=new Date-a.p[0]};a.w&&b();i.addEventListener?i.addEventListener(l,b,!1):i.attachEvent("on"+l,b);var q=function(){function b(){return["<head></head><",c,' onload="var d=',n,";d.getElementsByTagName('head')[0].",d,"(d.",g,"('script')).",i,"='",a.l,"'\"></",c,">"].join("")}var c="body",e=h[c];if(!e)return setTimeout(q,100);a.P(1);var d="appendChild",g="createElement",i="src",k=h[g]("div"),l=k[d](h[g]("div")),f=h[g]("iframe"),n="document",p;k.style.display="none";e.insertBefore(k,e.firstChild).id=o+"-"+j;f.frameBorder="0";f.id=o+"-frame-"+j;/MSIE[ ]+6/.test(navigator.userAgent)&&(f[i]="javascript:false");f.allowTransparency="true";l[d](f);try{f.contentWindow[n].open()}catch(s){a.domain=h.domain,p="javascript:var d="+n+".open();d.domain='"+h.domain+"';",f[i]=p+"void(0);"}try{var r=f.contentWindow[n];r.write(b());r.close()}catch(t){f[i]=p+'d.write("'+b().replace(/"/g,String.fromCharCode(92)+'"')+'");d.close();'}a.P(2)};a.l&&setTimeout(q,0)})()}();c[b].lv="1";return c[b]}var o="lightningjs",k=window[o]=g(o);k.require=g;k.modules=c}({});
    window.usabilla_live = lightningjs.require("usabilla_live", "//w.usabilla.com/a5a2c64ff5b8.js");
    /*]]>{/literal}*/</script>



<div class="usabilla_live_button_container" tabindex="0" style="right:0px;top:50%;margin-top:-65px;position:fixed;width:39px;height:130px;z-index:999" aria-label="Usabilla Feedback Button"><iframe src="Adding%20a%20Shopping%20Cart_files/adding-a-shopping-cart_002.html" style="width: 39px; height: 130px; margin: 0px; padding: 0px; border: 0px none; overflow: hidden; z-index: 9998; position: absolute; left: 0px; top: 0px; box-shadow: 0px 0px 0px; background-color: transparent;" marginwidth="0" marginheight="0" scrolling="no" data-tags="right" title="Usabilla Feedback Button" frameborder="0"></iframe></div></body></html>